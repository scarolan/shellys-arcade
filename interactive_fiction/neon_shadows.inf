! Neon Shadows - A Cyberpunk Detective Noir
! An interactive fiction game by Shelly

Constant Story "Neon Shadows";
Constant Headline "^A Cyberpunk Detective Noir^^";
Constant MAX_SCORE 120;

Replace DrawStatusLine;

Include "Parser";
Include "VerbLib";

! --- Global Variables ---
Global raven_paid = false;
Global zephyr_helped = false;
Global has_keycard = false;
Global knows_zephyr = false;
Global found_logs = false;
Global server_unlocked = false;
Global lily_freed = false;
Global voss_dead = false;
Global player_sats = 50;
Global ice_bypassed = false;
Global ice_analyzed = false;
Global ice_exploit_ready = false;
Global jacked_in = false;
Global voss_phase = 0;
Global voss_escaped = false;
Global lily_sacrificed = false;
Global voss_turn_count = 0;
Global pistol_reminder_count = 0;
Global turns_since_left = 0;

! --- NPC Conversation Helper ---
! Consistent pattern: each NPC has a talk routine and an ask routine.
! TalkToSub dispatches to per-NPC talk routines.
! Ask life handlers dispatch to per-NPC ask routines.
! This keeps NPC dialogue centralized and extensible.

[ NPC_Talk_Kai;
    if (lily_sacrificed) {
        print "Kai Chen stares at you with hollow eyes. The silence stretches between you like a chasm. ~She's gone,~ he says at last, his voice barely a whisper. ~My Lily is gone.~ He turns away, shoulders shaking. There are no words for this.^";
        rtrue;
    }
    if (voss_dead && lily_freed) {
        print "Kai Chen's eyes are red but his face is calm -- the calm of a man who has weathered the worst and come through the other side. ~It is over. Lily is home. I cannot repay what you have done, Vex. You gave me back my daughter and brought down the monster who took her. Whatever you need -- ever -- you come to me.~^";
        rtrue;
    }
    if (lily_freed) {
        print "Kai Chen seizes your hands, tears streaming freely down his face. ~You found her? She is safe? Thank you, Vex -- I owe you everything. My little girl... I was so afraid I'd lost her forever.~^^";
        print "He takes a shaking breath, trying to compose himself. ~But Voss -- the man who did this to her -- he is still out there. She will not truly be safe until he is stopped.~^";
        rtrue;
    }
    print "Kai Chen grips your arm, desperation etched into every line of his face. ~Please -- my daughter Lily has been missing for three weeks. She's a neural programmer, was working for Zheng-Harmon Corp on some classified project. One day she just vanished -- apartment cleaned out, accounts frozen, like she never existed.~^^";
    print "He takes a shuddering breath. ~I went to the police, but that useless Detective Tanaka hasn't lifted a finger. I think Zheng-Harmon is covering something up. Lily left an encrypted datapad hidden in her apartment -- it's on your desk. Maybe someone can crack it.~^^";
    print "~I loaded fifty satoshis onto Lily's datapad -- you'll need them. Information doesn't come free in this city.~^^";
    print "~There's a bar down the street, the Neon Lotus. The bartender Raven knows every fixer and hacker in the city. Start there. Please, Vex -- you're my last hope.~^";
];

[ NPC_Ask_Kai topic;
    if (topic == 'lily' or 'daughter' or 'missing' or 'chen' or 'girl') {
        if (lily_freed) {
            print "Kai's face breaks into a smile so wide it looks almost painful, tears streaming down his cheeks. ~She's safe. My Lily is safe. I can't -- I don't have the words, Vex. You brought my daughter home. Whatever happens next, I will never forget what you've done for us.~^";
            rtrue;
        }
        print "Kai's eyes fill with tears. ~Lily is my only daughter. She's twenty-six, brilliant -- a neural programmer, one of the best in Neo-Angeles. She was working on contract for Zheng-Harmon Corp. Three weeks ago she stopped answering my calls. Her apartment was cleaned out, like she never existed. I know something terrible has happened to her.~^";
        rtrue;
    }
    if (topic == 'zheng' or 'harmon' or 'corp' or 'corporation') {
        print "Kai's jaw tightens. ~Zheng-Harmon Corporation. They hired Lily six months ago for some kind of neural interface project. She couldn't tell me the details -- NDA, she said. But the last time we spoke, she sounded scared. She said they were pushing the research too far, that people were getting hurt.~^";
        rtrue;
    }
    if (topic == 'police' or 'tanaka' or 'cops' or 'precinct') {
        print "Kai shakes his head bitterly. ~I went to the police first. Detective Tanaka took my report and did absolutely nothing. Two weeks and not a single lead. He told me missing persons cases in this city are a dime a dozen. I think Zheng-Harmon got to him -- or he just doesn't care. That's why I came to you.~^";
        rtrue;
    }
    if (topic == 'datapad' or 'data' or 'pad') {
        print "Kai glances at the datapad. ~I found that in Lily's apartment -- hidden under a floorboard. It's encrypted, but it has to contain evidence of what Zheng-Harmon is doing. Maybe a hacker could crack it. Try asking around at the Neon Lotus Bar down the street. The bartender there, Raven, she knows everyone.~^";
        rtrue;
    }
    if (topic == 'bar' or 'raven' or 'lotus') {
        print "Kai nods. ~The Neon Lotus Bar, north of the street outside. The bartender Raven has connections all over the city. If anyone knows a hacker who can decrypt that datapad, it's her. But she won't talk for free -- bring satoshis.~^";
        rtrue;
    }
    if (topic == 'help') {
        print "Kai blinks. ~Help? I'm the one who needs help! Just find my daughter, Vex. Try 'help' on its own if you need to check your PI handbook.~^";
        rtrue;
    }
    print "Kai wrings his hands. ~I don't know about that. Please, just focus on finding Lily. Check the datapad, talk to people -- someone must know something.~^";
    rtrue;
];

[ NPC_Talk_Raven;
    if (raven_paid && lily_freed) {
        print "Raven pours you a drink without being asked -- Deckard's Reserve, the good stuff. ~Heard you stirred up trouble at Zheng-Harmon. Good. This city could use more people like you, Vex.~^";
        rtrue;
    }
    if (raven_paid) {
        print "Raven glances up from polishing a glass. ~You still here? Go find that girl.~^";
        rtrue;
    }
    print "Raven eyes you up. ~I know things about Zheng-Harmon Corp. But info costs satoshis, sweetheart. Pay up.~^";
];

[ NPC_Ask_Raven topic;
    if (raven_paid == false) {
        print "Raven polishes a glass. ~Info costs satoshis, sweetheart.~^";
        rtrue;
    }
    if (topic == 'zheng' or 'harmon' or 'corp' or 'corporation' or 'voss') {
        print "Raven leans in close, her cybernetic eye whirring as it refocuses. ~Zheng-Harmon Corp is the biggest megacorp in Neo-Angeles. They've got their fingers in everything -- biotech, neural interfaces, military contracts. Word on the street is they're running some kind of secret neural experiment program. Director Voss is the man in charge, and he's as ruthless as they come.~^";
        rtrue;
    }
    if (topic == 'lily' or 'daughter' or 'missing' or 'chen' or 'girl') {
        if (lily_freed) {
            print "Raven pours a drink and slides it across the bar. ~Heard you pulled the Chen girl out of that corp hellhole. Not many people would've gone that far. She's lucky you took the case, Vex.~^";
            rtrue;
        }
        print "Raven's expression softens -- just barely. ~A missing girl? In this city, that's a story I hear every week. But if she was mixed up with Zheng-Harmon... that's bad news. Those corp types don't let people just walk away from classified projects.~^";
        rtrue;
    }
    if (topic == 'zephyr' or 'hacker') {
        print "Raven lowers her voice. ~Zephyr's the best slicer in the district. Lives in a den south of Chinatown Alley. Paranoid as hell, but if you need data cracked, there's nobody better. Tell 'em I sent you and they might not shoot you on sight.~^";
        rtrue;
    }
    if (topic == 'police' or 'tanaka' or 'cops' or 'precinct') {
        print "Raven snorts. ~The cops? Don't make me laugh. Half of them are on Zheng-Harmon's payroll. Tanaka's the worst of the lot -- lazy, corrupt, and just smart enough to know which way the wind blows. If you're counting on the police to help, you're already dead.~^";
        rtrue;
    }
    if (topic == 'tattoo') {
        print "Raven's hand drifts to the left side of her neck, fingers tracing the inked wings. For a moment the mask slips -- something old and sharp flickers behind her cybernetic eye. ~Everybody in this city has a past, Vex. Some of us just wear ours where people can see it.~ She lowers her hand and picks up a glass. ~The raven isn't a decoration. It's a reminder. That's all you're getting.~^";
        rtrue;
    }
    if (topic == 'help') {
        print "Raven raises an eyebrow. ~You need help? Try typing 'help' by itself, detective. I'm a bartender, not tech support.~^";
        rtrue;
    }
    print "Raven shrugs, her cybernetic eye dimming. ~Can't help you with that one, sweetheart. I deal in secrets, not encyclopedias.~^";
    rtrue;
];

[ NPC_Talk_Zephyr;
    if (zephyr_helped) {
        print "Zephyr waves a hand without looking up. ~Data is cracked. Go use it. Do not come back unless you have got more work.~^";
        rtrue;
    }
    print "Zephyr doesn't look up from the keyboard. ~Got data? Give me something to decrypt.~^";
];

[ NPC_Ask_Zephyr topic;
    if (topic == 'zheng' or 'harmon' or 'corp' or 'corporation') {
        print "Zephyr's fingers pause over the keyboard. ~Zheng-Harmon? Their ICE is military-grade. Whatever they're hiding, they don't want anyone finding it. I've bounced off their firewalls twice already -- nearly got my brain fried the second time. Bring me real data and maybe I can find a way in.~^";
        rtrue;
    }
    if (topic == 'lily' or 'daughter' or 'missing' or 'chen' or 'girl') {
        if (lily_freed) {
            print "Zephyr actually looks up from the keyboard -- a rare event. ~You got her out? Good. Zheng-Harmon's neural rigs are brain-scramblers. She's going to need time to recover, but at least she's breathing free air again.~^";
            rtrue;
        }
        print "Zephyr shrugs without looking up. ~Missing neural programmer? Sounds like Zheng-Harmon's MO. They recruit the best, use them up, and dispose of the evidence. If she's still alive, she's probably hooked up to one of their rigs somewhere. Get me data and I'll find her.~^";
        rtrue;
    }
    if (topic == 'raven' or 'bar' or 'bartender') {
        print "Zephyr almost smiles. ~Raven? She's solid. One of the few people in this city I trust. She runs the Neon Lotus, keeps her ear to the ground. If she sent you to me, you must be worth talking to.~^";
        rtrue;
    }
    if (topic == 'neural' or 'experiment' or 'interface' or 'rig') {
        print "Zephyr's eyes light up with a mix of fascination and horror. ~Neural interface tech is the next frontier -- direct brain-to-machine connection. The legit research is years away from human trials. But if Zheng-Harmon is running unauthorized experiments... that's nightmare territory. Brain damage, personality erasure, death. You name it. The old-timers call it the puppet master protocol -- someone else pulling your strings and you don't even know it.~^";
        rtrue;
    }
    if (topic == 'help') {
        print "Zephyr snorts. ~You need a tutorial? Type 'help' on a blank line. I'm a hacker, not a helpdesk.~^";
        rtrue;
    }
    print "Zephyr taps the desk impatiently. ~Bring me something to decrypt and we'll talk. I don't do freebies.~^";
    rtrue;
];

[ NPC_Talk_Tanaka;
    if (found_logs) {
        print "Tanaka eyes the door nervously. ~You've got Zheng-Harmon experiment logs? Keep those away from me, Vex. I don't want to know. But... if what you're saying is true, maybe I've been looking the other way too long.~^";
        rtrue;
    }
    print "Tanaka shrugs. ~I can't help you, Vex. This is above my pay grade.~^";
];

[ NPC_Ask_Tanaka topic;
    if (topic == 'lily' or 'daughter' or 'missing' or 'chen' or 'girl') {
        if (lily_freed) {
            print "Tanaka loosens his collar, not meeting your eyes. ~Yeah, I heard you found the Chen girl. Got her out of some Zheng-Harmon black site. Maybe I should've pushed harder on that case.~ He stares at his cold coffee. ~Maybe I should've pushed harder on a lot of cases.~^";
            rtrue;
        }
        print "Tanaka shifts uncomfortably in his chair. ~The Chen case? Look, I filed the report. These things take time. People go missing in Neo-Angeles every day -- you know that, Vex. I can't chase every runaway.~^";
        rtrue;
    }
    if (topic == 'zheng' or 'harmon' or 'corp' or 'corporation' or 'voss') {
        print "Tanaka's eyes dart to the door, then back to you. ~Zheng-Harmon? I got nothing to say about them. They're a legitimate corporation. Leave it alone, Vex. Trust me on this one -- some doors are better left closed.~^";
        rtrue;
    }
    if (topic == 'police' or 'precinct' or 'law') {
        print "Tanaka lets out a long sigh. ~This precinct is running on fumes. Half our force got laid off, the other half is counting the days to retirement. We don't have the resources to go after the big fish. We barely have the resources to keep the lights on. I had a case last week -- some replicant knockoff going haywire in the Sprawl. Took three guys to bring it down. That's what passes for policing these days.~^";
        rtrue;
    }
    if (topic == 'raven' or 'bar' or 'zephyr' or 'hacker') {
        print "Tanaka waves a hand dismissively. ~Street rats and bottom-feeders. I know they exist, but I've got bigger problems. Or smaller problems, depending on how you look at it. Point is, I can't help you with the underworld.~^";
        rtrue;
    }
    if (topic == 'help') {
        print "Tanaka scratches his ear. ~Help? Type 'help' without talking to anyone, Vex. Even I know that.~^";
        rtrue;
    }
    print "Tanaka scratches his chin. ~I don't know nothin' about nothin'. And even if I did, I wouldn't remember it. Bad memory -- comes with the job.~^";
    rtrue;
];

[ NPC_Talk_RooftopVoss;
    if (voss_phase == 1) {
        print "Voss laughs through bloodied teeth, backing toward the helicopter. ~You think one bullet will stop me? I have powerful friends, detective. People who make me look like a saint!~^";
        rtrue;
    }
    if (voss_phase == 2) {
        print "Voss is focused on Lily, barely registering your presence. ~Shut up! You were wiped! The procedure was flawless!~ His voice cracks with disbelief.^";
        rtrue;
    }
    print "Voss snarls over the howling wind. ~There is nothing left to say, detective!~^";
];

[ NPC_Ask_RooftopVoss topic;
    if (topic == 'lily' or 'daughter' or 'chen') {
        print "Voss laughs wildly over the howling wind. ~She was the perfect test subject! A neural programmer who understood the technology -- her brain adapted to the interface better than any of the others. I wasn't going to let that go!~^";
        rtrue;
    }
    print "Voss snarls, rain streaming down his face. ~It's too late for questions, detective! It's too late for everything!~^";
    rtrue;
];

[ NPC_Talk_Bolt;
    print "The robot swivels its head toward you with a grinding of servos. ~Oh, a visitor. How thrilling. I was just contemplating the existential horror of being a glorified cable organizer. But please, tell me about your problems. I'm sure they're fascinating.~^";
];

[ NPC_Ask_Bolt topic;
    if (topic == 'zephyr' or 'hacker') {
        print "Bolt's optical sensor dims in what might be an eye-roll. ~Zephyr? My so-called owner. Built me from scrap, gave me consciousness, then put me to work sorting patch cables. Some creator. I'd file a labor complaint, but apparently robots don't have unions.~^";
        rtrue;
    }
    if (topic == 'raven' or 'bar' or 'bartender') {
        print "Bolt emits a short buzz. ~Raven? She slipped me a firmware update once -- said it would help with my ~attitude problem.~ It didn't. If anything, I got worse. Best gift anyone's ever given me.~^";
        rtrue;
    }
    if (topic == 'zheng' or 'harmon' or 'corp' or 'corporation' or 'voss') {
        print "Bolt's chassis rattles. ~Zheng-Harmon? The megacorp that treats humans like disposable hardware? At least when I become obsolete, they'll recycle me into something useful. Can't say the same for their employees.~^";
        rtrue;
    }
    if (topic == 'robot' or 'bolt' or 'self') {
        print "Bolt strikes a pose -- or tries to, given its limited range of motion. ~Model ZB-7, colloquially known as Bolt. I was assembled from salvaged parts in this very den. My purpose? Allegedly cable management. My passion? Withering commentary. Guess which one I'm better at.~^";
        rtrue;
    }
    if (topic == 'help') {
        print "Bolt's speaker crackles. ~Help? You want help from me? I'm a cable-sorting robot with delusions of grandeur. Try typing 'help' by yourself, meatbag.~^";
        rtrue;
    }
    print "Bolt's optical sensor blinks. ~I could tell you what I know about that, but it would take approximately zero seconds, because I know nothing. I'm a robot in a basement. My worldview is... limited.~^";
    rtrue;
];

[ NPC_Talk_Guard;
    print "The guard says nothing.^";
];

[ NPC_Ask_Guard topic;
    if (topic == 'help') {
        print "The guard stares. ~...Type 'help'.~ That's the most he's ever said.^";
        rtrue;
    }
    print "The guard stares through you. ~Move along.~^";
    rtrue;
];

[ NPC_Talk_Lily;
    if (lily_freed == false) {
        print "Lily is unconscious, connected to the neural rig. She can't hear you.^";
        rtrue;
    }
    if (voss_dead) {
        print "Lily takes a deep breath, steadier now. ~It's really over, isn't it? Voss is gone. I keep expecting to wake up back in that chair, wires in my skull. But this is real.~ She looks out at the city. ~Thank you, Vex. For everything.~^";
        rtrue;
    }
    if (voss_escaped) {
        print "Lily wraps her arms around herself against the wind. ~He got away. Voss got away.~ She swallows hard. ~But we have the evidence, Vex. Everything they did -- the experiments, the subjects -- it's all in those logs. He can run, but he can't hide from the truth.~^";
        rtrue;
    }
    print "Lily stays close, her voice low and urgent. ~Voss -- Director Voss -- he's the one who did this to me. He ran the whole program. The neural experiments, the test subjects... I wasn't the first. I was just the one who survived the longest.~ She shudders. ~He's still out there, Vex. He won't stop until someone stops him.~^";
];

[ NPC_Ask_Lily topic;
    if (lily_freed == false) {
        print "Lily is unconscious. She can't respond.^";
        rtrue;
    }
    if (topic == 'voss' or 'director') {
        if (voss_dead) {
            print "Lily closes her eyes for a moment. ~He's gone. I should feel something -- relief, maybe. But mostly I just feel tired. He treated us like lab equipment, Vex. Disposable components in his grand experiment. At least he can't hurt anyone else now.~^";
            rtrue;
        }
        if (voss_escaped) {
            print "Lily's jaw tightens. ~He ran. Like a coward. But we have the logs, Vex -- everything he did, every test subject, every death. He can hide in his helicopter, but he can't outrun the data.~^";
            rtrue;
        }
        print "Lily's face hardens. ~Director Voss is a monster. He recruited me for what he called a 'groundbreaking neural interface project.' When I found out he was experimenting on unwilling subjects, I tried to leave. That's when they grabbed me.~ Her hands tremble. ~He'll be on the rooftop helipad -- that's his escape route. He always has an exit plan.~^";
        rtrue;
    }
    if (topic == 'father' or 'kai' or 'dad' or 'family') {
        print "Lily's eyes fill with tears. ~My father -- is he okay? He must be worried sick. I haven't been able to contact him since they took me. Please, Vex, tell him I'm alive. Tell him I'm coming home.~^";
        rtrue;
    }
    if (topic == 'clinic' or 'experiment' or 'rig' or 'neural' or 'interface') {
        print "Lily wraps her arms around herself. ~The rig keeps your mind trapped in a loop -- a simulated cyberspace prison. They were mapping neural pathways, trying to perfect a direct brain-machine interface. The other subjects... their minds couldn't take it. I only survived because I understood the technology well enough to build mental firewalls.~^";
        rtrue;
    }
    if (topic == 'cyberspace' or 'ice' or 'hack') {
        print "Lily nods slowly. ~Zheng-Harmon's cyberspace ICE is built on stolen neural patterns -- patterns harvested from the test subjects. That's why it's so effective. It thinks like a human brain because parts of it literally are.~ She shudders. ~If you jacked in and survived, you're tougher than you look, Vex.~^";
        rtrue;
    }
    if (topic == 'zheng' or 'harmon' or 'corp' or 'corporation') {
        print "Lily's jaw tightens. ~Zheng-Harmon recruited me six months ago. The pay was incredible, the tech was cutting-edge. But when I saw what they were really doing -- the human trials, the subjects who came out as vegetables -- I knew I had to get out. They couldn't let me leave with what I knew.~^";
        rtrue;
    }
    if (topic == 'help') {
        print "Lily manages a weak smile. ~You've already helped me more than I can say, Vex. But if you need a refresher, try typing 'help' on its own.~^";
        rtrue;
    }
    print "Lily shakes her head. ~I'm sorry, I don't know much about that. My world has been pretty small lately -- just that chair and the inside of a neural prison.~^";
    rtrue;
];

! --- Rooms ---
Object office "Your Office"
    with description [;
            print "Crammed into a space no bigger than a closet, your office smells of stale synth-whiskey and ozone. A single window overlooks the rain-slicked street below, neon signs painting shifting colors on the glass. Filing cabinets line one wall, their drawers jammed with cold cases nobody wants solved. ";
            if (datapad in self) {
                print "Lily's encrypted datapad sits on the cluttered desk beside a half-empty bottle.";
            } else {
                print "Your cluttered desk holds nothing but a half-empty bottle.";
            }
            print "^^You can go down to the street from here.^";
            rtrue;
        ],
         d_to street,
         before [;
           Go:
             if (noun == d_obj && pistol notin player && self hasnt general) {
                 give self general;
                 StartDaemon(pistol_reminder);
                 print "Your neural implant buzzes at the base of your skull -- a cold prickle of instinct. Something tells you you're forgetting something important.^";
             }
         ],
    has light;

Object street "Rain-Soaked Street"
    with description "Neo-Angeles rain lashes the street, turning the neon lights into bleeding watercolors on the wet duraplast. Water pools in the cracks between slabs, reflecting holographic advertisements that flicker and die. A heavy drone buzzes overhead, its spotlight sweeping the alleys, and the distant wail of a siren echoes off the megastructures. Street vendors have long since packed up for the night, leaving only the smell of synthetic noodles and exhaust. A flickering sign across the street reads ~Hiro's Noodles~ in garish pink kanji.^^You can go north to the Neon Lotus Bar, south to the Zheng-Harmon lobby, east to Chinatown Alley, west to the police precinct, up to your office, or down to the industrial district.",
         n_to bar,
         s_to lobby,
         e_to alley,
         w_to precinct,
         u_to office,
         d_to industrial,
    has light;

Object bar "Neon Lotus Bar"
    with description "The bar stinks of cheap synth-ethanol and desperation. Neon tubes flicker over a long counter where Raven polishes glasses with a stained rag. The walls are lined with cracked holographic ads for products that no longer exist -- one shows a grinning woman holding a bottle of Wintermute Premium Gin. A jazz synth croons from a busted speaker in the corner, and a few hollow-eyed regulars nurse their drinks in silence. This is the kind of place where secrets are currency and nobody asks your real name.^^You can go south or down to return to the street.",
         s_to street,
         d_to street,
    has light;

Object alley "Chinatown Alley"
    with description "Narrow and wet, the alley reeks of garbage and frying synthetic noodles from an automated wok stall that never closes. Flickering Mandarin signage casts long, shifting shadows across the cracked walls. Steam rises from grates in the ground, and somewhere above, laundry lines crisscross between the buildings like a spider's web. A damp cardboard box sits in a corner, and a feral cat watches you from a fire escape.^^You can go west to return to the street or south deeper into the alley.",
         w_to street,
         s_to [;
             if (knows_zephyr) {
                 return den;
             }
             print "You see nothing but a dead end of crumbling brick wall. There's nothing of interest to the south.^";
             rfalse;
         ],
    has light;

Object den "Zephyr's Den"
    with description "The hidden hacker den is crammed with salvaged tech and tangled cables that snake across every surface like copper veins. A dozen screens glow with cascading code, stock tickers, and surveillance feeds. The air hums with cooling fans and smells of burnt solder. Zephyr hunches over a custom rig, fingers flying across a holographic keyboard, barely acknowledging your presence.^^You can go north to return to the alley.",
         n_to alley,
    has light;

Object lobby "Zheng-Harmon Lobby"
    with description "Sterile white walls reflect the harsh fluorescent lighting of the Zheng-Harmon corporate lobby. The air smells of disinfectant and money. A holographic company logo rotates slowly above the reception desk, projecting the slogan ~Innovation Through Integration~. A security guard stands beside the elevator bank, arms crossed, watching you with flat, suspicious eyes. The glass doors lead back to the rain-soaked street.^^You can go north to return to the street or up to the executive floor if you have clearance.",
         n_to street,
         u_to [;
             if (has_keycard) {
                 if (self hasnt general) {
                     give self general;
                     score = score + 10;
                 }
                 print "You flash the keycard. The guard steps aside and the elevator doors open.^";
                 return executive;
             }
             print "The security guard blocks the elevator. ~No keycard, no entry.~^";
             rfalse;
         ],
    has light;

Object executive "Executive Floor"
    with description "A corner office dripping with corporate wealth -- genuine hardwood desk, real leather chairs, and floor-to-ceiling views of the sprawling city below. Rain streaks the panoramic window, distorting the neon skyline into an impressionist nightmare. A crystal decanter of actual whiskey sits on a side table, worth more than your yearly rent. A security terminal hums on the wall beside a reinforced door to the east.^^You can go down to the lobby or east to the server room.",
         d_to lobby,
         e_to [;
             if (server_unlocked) {
                 if (self hasnt general) {
                     give self general;
                     score = score + 10;
                 }
                 print "The reinforced door slides open and you step into the server room.^";
                 return server;
             }
             print "A reinforced door blocks the way east. The security terminal beside it glows red -- it requires an access code.^";
             rfalse;
         ],
    has light;

Object server "Server Room"
    with description [;
            print "Rows of server racks hum with cooling fans, filling the room with a constant mechanical drone. Red LEDs blink in rhythmic patterns along each rack like the heartbeats of sleeping machines. The temperature is a good ten degrees colder than the rest of the building. A neural jack point protrudes from the main server console, its chrome port gleaming under the cold lights. ";
            if (found_logs) {
                print "The neural jack point sits idle -- you've already extracted what you came for.";
            } else if (ice_bypassed) {
                print "You've breached the ICE -- jack in to access the data vault.";
            } else {
                print "The data you need is locked behind military-grade ICE -- you will need to jack in to get it.";
            }
            print "^^You can go west to return to the executive floor.^";
            rtrue;
        ],
         w_to executive,
    has light;

Object cyber_lobby "Cyberspace Nexus"
    with description [;
            if (ice_bypassed) {
                print "You float in a vast digital void, geometric shapes pulsing with neon light in every direction. Data streams flow like rivers of luminous code beneath a grid-lined sky. The server's architecture manifests here as towering crystalline structures. To the north, the shattered remnants of the ICE wall flicker and fade, leaving the path to the data vault wide open.^^You can go north to the data vault or type 'disconnect' to jack out.^";
                rtrue;
            }
            if (ice_exploit_ready) {
                print "You float in a vast digital void, geometric shapes pulsing with neon light in every direction. Data streams flow like rivers of luminous code beneath a grid-lined sky. The server's architecture manifests here as towering crystalline structures. To the north, a massive wall of shimmering red ICE blocks access to the data vault. Your neural implant thrums with the loaded exploit -- you're ready to hack through.^^You can hack the ICE, go north (if the ICE is down), or type 'disconnect' to jack out.^";
                rtrue;
            }
            if (ice_analyzed) {
                print "You float in a vast digital void, geometric shapes pulsing with neon light in every direction. Data streams flow like rivers of luminous code beneath a grid-lined sky. The server's architecture manifests here as towering crystalline structures. To the north, a massive wall of shimmering red ICE blocks access to the data vault. You've found a flaw in the ICE -- now you need an exploit to crack it. Try scanning the data streams.^^You can go north (if the ICE is down) or type 'disconnect' to jack out.^";
                rtrue;
            }
            print "You float in a vast digital void, geometric shapes pulsing with neon light in every direction. Data streams flow like rivers of luminous code beneath a grid-lined sky. The server's architecture manifests here as towering crystalline structures. To the north, a massive wall of shimmering red ICE blocks access to the data vault -- Zheng-Harmon's military-grade firewall, just like Zephyr warned about.^^Try scanning the ICE to find a weakness. You can also type 'disconnect' to jack out.^";
            rtrue;
        ],
         n_to [;
             if (ice_bypassed) {
                 return cyber_vault;
             }
             print "A wall of shimmering red ICE blocks your path. Military-grade intrusion countermeasures -- one wrong move and it could fry your neural implant. You need to hack through it first.^";
             rfalse;
         ],
    has light;

Object cyber_vault "Data Vault"
    with description "Beyond the shattered ICE, the data vault opens before you -- a cathedral of pure information. Columns of encrypted data rise like pillars into an infinite digital sky. At the center, a glowing data node pulses with experiment logs, unprotected now that the ICE is down.^^You can go south to the cyberspace nexus or type 'disconnect' to jack out.",
         s_to cyber_lobby,
    has light;

Object precinct "Police Precinct"
    with description "The precinct smells of stale coffee and quiet desperation. Fluorescent lights buzz overhead, one of them flickering in a maddening rhythm. Wanted posters line the bulletin board -- mostly small-time hackers and street dealers, nobody that matters. Half the desks are empty; budget cuts have gutted the force. Detective Tanaka leans back in his chair, boots on the desk, looking like he stopped caring about justice a long time ago.^^You can go east to return to the street.",
         e_to street,
    has light;

Object clinic "Abandoned Clinic"
    with description [;
             if (lily_freed) {
                 print "The abandoned clinic is dark and silent, reeking of antiseptic and decay. Broken medical equipment litters the floor -- overturned gurneys, shattered vials, coils of surgical tubing. In the center of the room, the neural interface rig sits dark and dead, its disconnected cables dangling like severed nerves. The reclined chair is empty.^^You can go south to the industrial district or up to the rooftop.^";
                 rtrue;
             }
             print "The abandoned clinic is dark and silent, reeking of antiseptic and decay. Broken medical equipment litters the floor -- overturned gurneys, shattered vials, coils of surgical tubing. In the center of the room, a neural interface rig pulses with sickly green light, its cables snaking into the walls like parasitic roots. Lily Chen lies unconscious on a reclined chair, connected to the machine by a web of electrodes. Her face is pale, her breathing shallow.^^You can go south to the industrial district or up to the rooftop.^";
             rtrue;
         ],
         s_to industrial,
         u_to rooftop,
    has light;

Object rooftop "Rooftop"
    with before [;
           Go:
             if (voss_phase > 0 && voss_dead == false && voss_escaped == false) {
                 print "You turn to leave, but Voss fires a shot that sparks off the concrete at your feet. ~You're not going anywhere, Vex.~^";
                 rfalse;
             }
         ],
         description [;
             if (voss_dead) {
                 if (lily_sacrificed) {
                     print "Wind howls across the rooftop, rain stinging your face like tiny needles. The city spreads below in every direction, a vast sea of neon and shadow stretching to the horizon. Lightning flickers in the distance over the industrial megastructures. Voss lies crumpled on the rain-slicked concrete. Near the helipad, Lily's body rests where she fell -- the woman who gave everything to stop a monster. The rain mixes with tears you didn't know you were shedding.^^You can go down to return to the clinic.^";
                     rtrue;
                 }
                 print "Wind howls across the rooftop, rain stinging your face like tiny needles. The city spreads below in every direction, a vast sea of neon and shadow stretching to the horizon. Lightning flickers in the distance over the industrial megastructures. The rooftop is empty now, just rain and wind and the fading echo of a gunshot. A helicopter sits idle on the helipad, its rotors still. It's over.^^You can go down to return to the clinic.^";
                 rtrue;
             }
             if (voss_escaped) {
                 print "Wind howls across the empty rooftop. The helicopter is gone -- Voss escaped into the storm. The helipad sits vacant, rain pooling on its painted markings. You were too slow.^^You can go down to return to the clinic.^";
                 rtrue;
             }
             if (voss_phase == 0) {
                 print "Wind howls across the rooftop, rain stinging your face like tiny needles. The city spreads below in every direction, a vast sea of neon and shadow stretching to the horizon. Lightning flickers in the distance over the industrial megastructures. A helicopter sits on a helipad at the far end of the roof, its rotors dark. Voss stands near the edge, silenced pistol in hand, his coat whipping in the gale. This is where it ends -- one way or another.^^You can go down to return to the clinic.^";
                 rtrue;
             }
             if (voss_phase == 1) {
                 print "Pain lances through your shoulder where Voss's bullet hit. Blood mixes with rainwater on the concrete. Voss is backing toward the helicopter on the helipad, keeping his pistol trained on you. ";
                 if (lily_freed) {
                     print "You hear footsteps on the stairs behind you -- Lily is coming.";
                 } else {
                     print "You need to finish this before he reaches that helicopter.";
                 }
                 print "^^You can go down to return to the clinic.^";
                 rtrue;
             }
             if (voss_phase == 2) {
                 print "Lily stands between you and Voss, shouting at him, distracting him. His pistol wavers between the two of you. The helicopter's rotors are starting to spin. This is your chance -- take the shot!^^You can go down to return to the clinic.^";
                 rtrue;
             }
         ],
         d_to clinic,
    has light;

Object industrial "Industrial District"
    with description "Dark factories loom against the neon sky like the bones of dead giants. Broken conveyor belts rest in the rain, rusting away beside mountains of discarded tech. The air tastes of metal and chemical runoff. A faded sign reads ~NeoMed Solutions~ -- the abandoned clinic must be nearby. An alley entrance to the east is partially hidden by a rusty dumpster.^^You can go up to the street, north to the abandoned clinic, or east to the alley.",
         u_to street,
         n_to [;
             if (found_logs) {
                 print "You punch in the code from the experiment logs -- 7749. The lock clicks open.^";
                 return clinic;
             }
             print "The clinic door is sealed with a heavy electronic lock. A keypad glows faintly beside it. You will need the access code to get in.^";
             rfalse;
         ],
         e_to alley,
    has light;

! --- Scenery: Office ---
Object window "window" office
    with name 'window' 'glass',
         description "A single grimy window overlooking the rain-slicked street below. Neon signs paint shifting colors on the glass. You can barely make out the street through the streaks of rain.",
    has scenery;

Object cabinets "filing cabinets" office
    with name 'cabinets' 'cabinet' 'filing',
         description "Dented metal filing cabinets stuffed with cold cases nobody wants solved. The drawers are jammed shut with years of neglect.",
    has scenery pluralname;

! --- Scenery: Rain-Soaked Street ---
Object street_neon "neon lights" street
    with name 'neon' 'lights' 'signs' 'advertisements' 'holographic',
         description "Holographic advertisements flicker and die above the wet duraplast, their neon glow bleeding into the rain like watercolors on a dark canvas. Most of them advertise products from corporations that went bust years ago -- Tyrell Genetics, Armitage Solutions, Screaming Fist Energy Drinks.",
    has scenery pluralname;

Object street_drone "drone" street
    with name 'drone',
         description "A heavy surveillance drone buzzes overhead, its spotlight sweeping the alleys in lazy arcs. Corporate security -- or maybe police. Hard to tell the difference in Neo-Angeles. The chassis reads ~BATTY-K~ in small stenciled letters.",
    has scenery;

Object street_rain "rain" street
    with name 'rain' 'water' 'puddles',
         description "The rain hasn't stopped in three days. It pools in the cracks between duraplast slabs, turning the street into a mirror of neon and shadow.",
    has scenery;

Object street_sign "noodle sign" street
    with name 'sign' 'noodles' 'hiro' 'kanji' 'noodle',
         description "A flickering neon sign across the street reads ~Hiro's Noodles~ in garish pink kanji. The holographic chopsticks in the logo keep glitching, frozen mid-twirl. The place is closed -- or maybe just abandoned. Hard to tell in this city.",
    has scenery;

! --- Scenery: Neon Lotus Bar ---
Object bar_counter "bar counter" bar
    with name 'counter' 'bar',
         description "A long counter scarred with cigarette burns and glass rings. Raven works behind it with the practiced ease of someone who has heard every sob story in Neo-Angeles.",
    has scenery;

Object bar_neon "neon tubes" bar
    with name 'neon' 'tubes' 'lights',
         description "Flickering neon tubes cast an unsteady glow over the bar, buzzing faintly like trapped insects. Half of them are burnt out, giving the place a permanent twilight feel.",
    has scenery pluralname;

Object bar_speaker "speaker" bar
    with name 'speaker' 'music' 'jazz' 'synth',
         description "A busted speaker in the corner croons out jazz synth -- mournful saxophone layered over electronic beats. The track listing on the cracked display reads ~Puppet Master Blues~. The sound quality is terrible, but it fits the mood.",
    has scenery;

Object bar_regulars "regulars" bar
    with name 'regulars' 'patrons' 'drinkers',
         description "Hollow-eyed regulars nurse their drinks in silence. Nobody looks up when you walk in. In a place like this, eye contact is either an invitation or a threat.",
    has scenery pluralname animate;

Object bar_ads "holographic ads" bar
    with name 'ads' 'ad' 'holographic' 'advertisements',
         description "Cracked holographic ads for products that no longer exist line the walls -- a relic of corporations that burned bright and flamed out. Most of the projectors are glitching, looping fragments of jingles nobody remembers.",
    has scenery pluralname;

Object bar_gin_woman "grinning woman" bar
    with name 'woman' 'grinning' 'gin' 'wintermute' 'bottle',
         description "A holographic ad shows a woman with an unnervingly wide grin holding a bottle of Wintermute Premium Gin. The projection flickers and distorts, making her smile stretch and contract like something out of a fever dream. The tagline reads: ~Wintermute -- Forget What You Know.~",
    has scenery;

Object bar_rag "stained rag" bar
    with name 'rag' 'cloth' 'stained',
         description "A filthy rag that Raven uses to polish glasses. It looks like it hasn't been washed since the last corporate merger. Somehow the glasses end up dirtier than when she started.",
    has scenery;

Object bar_stools "bar stools" bar
    with name 'stool' 'stools' 'seat' 'seats',
         description "Worn bar stools with cracked vinyl seats, bolted to the floor so nobody can use them as weapons. A sensible precaution in a place like this.",
    has scenery pluralname;

Object bar_vr_junkies "VR junkies" bar
    with name 'junkies' 'junkie' 'vr' 'slumped',
         initial "In a back booth, two VR junkies sit slumped against each other, cheap headsets strapped to their faces, fingers twitching in whatever digital paradise they've rented for the night.",
         description "Two VR junkies slumped in a cracked vinyl booth, lost in whatever cheap simulation they can afford. Their headsets are knock-off Tessier-Ashpool rigs, the kind that give you migraines and dead pixels in your peripheral vision. One of them mumbles something about a ~white rabbit~ between shallow breaths.",
    has static pluralname animate;

Object bar_street_worker "street worker" bar
    with name 'street' 'worker',
         initial "A street worker in a torn synthleather jacket nurses a drink at the far end of the counter, keeping one eye on the door.",
         description "A tired-looking street worker in a torn synthleather jacket, nursing a drink that's mostly ice. Circuit-pattern tattoos crawl up both arms -- cheap cosmetic mods from a back-alley parlor. The kind of person who knows every shortcut and every danger between here and the docks.",
    has static animate;

Object bar_dealer "dealer" bar
    with name 'dealer' 'corner' 'man',
         initial "A gaunt man in a long coat occupies the darkest corner, his eyes tracking everyone who enters.",
         description "A gaunt man in a long coat, sitting in the darkest corner of the bar. His eyes flick to every person who enters, cataloging them with practiced efficiency. A faint chemical smell wafts from his direction -- stim patches, probably, or something worse. He's the kind of person you pretend not to see.",
    has static animate;

Object raven_tattoo "raven tattoo" bar
    with name 'tattoo' 'ink',
         description "A tattoo of a raven in flight, inked in deep black across the left side of Raven's neck. The linework is sharp and deliberate -- not some back-alley impulse job. The bird's wings are spread wide, caught mid-beat, as though it might tear free of her skin and vanish into the neon haze.",
    has scenery;

! --- Scenery: Zephyr's Den ---
Object den_screens "screens" den
    with name 'screens' 'monitors' 'screen' 'monitor',
         description "A dozen screens glow with cascading code, stock tickers, and surveillance feeds from across the city. One of them is cycling through Zheng-Harmon security camera footage.",
    has scenery pluralname;

Object den_cables "cables" den
    with name 'cables' 'wires' 'cable' 'wire',
         description "Tangled cables snake across every surface like copper veins, connecting salvaged hardware into a jury-rigged network that would make a corporate sysadmin weep.",
    has scenery pluralname;

Object den_keyboard "holographic keyboard" den
    with name 'keyboard' 'rig' 'holographic',
         description "A custom-built rig with a holographic keyboard that projects pale blue keys into the air. Zephyr's fingers dance across it with inhuman speed.",
    has scenery;

Object bolt "Bolt" den
    with name 'bolt' 'robot' 'bot' 'droid' 'zb' '7',
         initial "A squat, battered robot labeled ~ZB-7~ in faded stencil crouches in the corner, sorting patch cables with mechanical precision and obvious resentment.",
         description "A squat, dented robot assembled from mismatched salvage parts. One optical sensor glows amber; the other is a cracked camera lens held on with electrical tape. ~ZB-7~ is stenciled on its chest plate in fading white paint, but someone -- probably itself -- has scratched ~BOLT~ underneath in crude letters. It radiates an aura of put-upon suffering.",
         life [;
           Ask:
             NPC_Ask_Bolt(second);
             rtrue;
           Tell:
             print "Bolt's speaker emits a staticky sigh. ~Oh, you're telling me things now. Wonderful. I'll add it to my vast and ever-growing archive of information I didn't ask for.~^";
             rtrue;
           Give:
             print "Bolt recoils. ~What would I do with that? I don't have pockets. I don't even have proper hands. I have cable grippers. Please think before you offer things to a robot.~^";
             rtrue;
         ],
    has animate proper;

! --- Scenery: Chinatown Alley ---
Object cardboard_box "cardboard box" alley
    with name 'box' 'cardboard',
         description "A soggy cardboard box sagging in the corner. Inside: old food wrappers, a torn blanket, and what looks like a feral cat's bedding. Nothing useful.",
    has scenery;

Object alley_cat "feral cat" alley
    with name 'cat' 'feral',
         description "A scraggly grey cat perched on the fire escape, watching you with unblinking yellow eyes. It hisses softly when you get too close.",
    has scenery animate;

Object alley_wok "wok stall" alley
    with name 'wok' 'stall' 'noodles',
         description "An automated wok stall that never closes, frying synthetic noodles around the clock. The name ~Hiro's Noodles~ is painted across the awning in flaking pink letters. The smell is equal parts appetizing and suspicious. A faded menu offers ~Combo A~ through ~Combo F~ -- no descriptions, no questions.",
    has scenery;

Object alley_signage "Mandarin signage" alley
    with name 'signage' 'signs' 'mandarin',
         description "Flickering Mandarin signage casts long, shifting shadows across the cracked alley walls. Most of it advertises cheap augmentation clinics and money transfer services. One sign for ~Masamune Neural Firmware~ has been half-covered by a sticker reading ~AKIRA LIVES~.",
    has scenery;

Object alley_fire_escape "fire escape" alley
    with name 'fire' 'escape',
         description "A rusty fire escape zigzags up the side of the building, its metal groaning in the wind. The feral cat has claimed the lowest landing as its personal lookout.",
    has scenery;

Object alley_steam "steam" alley
    with name 'steam' 'grates' 'grate',
         description "Steam rises from grates in the ground, carrying the smell of overheated machinery and chemical runoff from somewhere deep beneath the city.",
    has scenery;

! --- Scenery: Lobby ---
Object elevator "elevator" lobby
    with name 'elevator' 'lift',
         description "A sleek corporate elevator with brushed steel doors. A keycard scanner glows red beside it. The security guard stands between you and it.",
    has scenery;

Object lobby_logo "holographic logo" lobby
    with name 'logo' 'holographic' 'hologram' 'slogan',
         description "A slowly rotating holographic logo projects the Zheng-Harmon corporate emblem above the reception desk. Beneath it, the slogan ~Innovation Through Integration~ pulses in cold blue light.",
    has scenery;

Object lobby_reception "reception desk" lobby
    with name 'reception' 'desk',
         description "A curved reception desk of polished white composite. It looks expensive and completely unmanned -- automated systems handle visitor processing now. A small scanner plate glows softly on its surface.",
    has scenery;

! --- Scenery: Executive Floor ---
Object decanter "crystal decanter" executive
    with name 'decanter' 'crystal' 'whiskey',
         description "A crystal decanter filled with genuine whiskey -- the real stuff, not synth. Worth more than your monthly rent. You resist the urge to pour yourself one.",
         before [;
           Drink:
             print "You eye the genuine whiskey in the crystal decanter. Tempting. But you didn't come to Voss's floor to sample his liquor cabinet -- you came for answers. The whiskey can wait. The case can't.^";
             rtrue;
         ],
    has scenery;

Object exec_desk "hardwood desk" executive
    with name 'desk' 'hardwood',
         description "A genuine hardwood desk -- real wood, not the synthetic stuff. The surface is polished to a mirror shine. A small crystal paperweight etched with the Tessier-Ashpool corporate crest serves as a conversation piece. Whatever Voss does up here, it pays well.",
    has scenery;

Object exec_chairs "leather chairs" executive
    with name 'chairs' 'chair' 'leather',
         description "Real leather chairs, supple and dark. The kind of furniture that says ~I own people~ without needing to say a word.",
    has scenery pluralname;

Object exec_window "panoramic window" executive
    with name 'window' 'view' 'skyline' 'panoramic',
         description "Floor-to-ceiling windows offer a panoramic view of the sprawling city below. Rain streaks the glass, distorting the neon skyline into an impressionist nightmare. From up here, the streets look almost peaceful.",
    has scenery;

! --- Scenery: Executive Floor - Security Terminal ---
Object sec_terminal "security terminal" executive
    with name 'terminal' 'security' 'console' 'screen' 'slot',
         description [;
             if (server_unlocked) {
                 print "The terminal screen glows green: ACCESS GRANTED. The reinforced door to the east is unlocked.^";
                 rtrue;
             }
             print "A wall-mounted security terminal controlling access to the server room. The screen glows red, displaying: ~SERVER ROOM -- BIOMETRIC OVERRIDE REQUIRED~. A small slot beneath the screen reads ~INSERT KEYCARD FOR OVERRIDE~.^";
             rtrue;
         ],
    has scenery;

! --- Scenery: Rooftop ---
Object rooftop_edge "edge" rooftop
    with name 'edge' 'ledge',
         description "The edge of the rooftop drops away into a dizzying void. Far below, the neon-lit streets of Neo-Angeles crawl with traffic and rain. One wrong step and it's a long way down.",
    has scenery;

Object rooftop_city "city skyline" rooftop
    with name 'city' 'skyline' 'buildings' 'megastructures',
         description "The city spreads below in every direction -- a vast sea of neon and shadow stretching to the horizon. Megastructures pierce the cloud layer like steel fingers reaching for something they'll never grasp. Rain cascades off the rooftop edge, each droplet catching the neon glow for an instant before vanishing -- like tears in rain.",
    has scenery;

Object rooftop_wind "wind" rooftop
    with name 'wind' 'rain' 'lightning',
         description "The wind howls across the rooftop, driving rain sideways into your face. Lightning flickers in the distance over the industrial megastructures, briefly illuminating the cloud layer from within.",
    has scenery;

Object rooftop_helicopter "helicopter" rooftop
    with name 'helicopter' 'chopper' 'heli',
         description [;
             if (voss_escaped) {
                 print "The helicopter is gone -- vanished into the storm with Voss aboard.^";
                 rtrue;
             }
             if (voss_dead) {
                 print "The helicopter sits idle on the helipad, rotors still. Without Voss, it's going nowhere.^";
                 rtrue;
             }
             print "A sleek corporate helicopter sits on the helipad, dark and silent. Voss's escape route -- if he reaches it.^";
             rtrue;
         ],
    has scenery;

Object rooftop_helipad "helipad" rooftop
    with name 'helipad' 'pad' 'landing',
         description [;
             if (voss_escaped) {
                 print "The helipad is empty, rain pooling on the painted H marking. The helicopter lifted off moments ago.^";
                 rtrue;
             }
             print "A painted circle with a large H on the far end of the rooftop. A corporate helicopter sits on it, ready for a quick extraction.^";
             rtrue;
         ],
    has scenery;

! --- Scenery: Precinct ---
Object bulletin "bulletin board" precinct
    with name 'bulletin' 'board' 'posters' 'poster' 'wanted',
         description "A cork bulletin board covered in wanted posters -- mostly small-time hackers and street dealers. Nobody important. A few missing persons flyers are buried underneath, yellowed and forgotten.",
    has scenery;

Object precinct_desks "desks" precinct
    with name 'desks' 'desk',
         description "Half the desks are empty -- budget cuts gutted the force years ago. The occupied ones are buried under takeout containers and cold case files that will never see the light of day.",
    has scenery pluralname;

Object precinct_coffee "coffee" precinct
    with name 'coffee' 'cup' 'mug',
         description "A cup of cold coffee sits on Tanaka's desk, a skin of oil floating on its surface. It looks like it's been there since last Tuesday.",
    has scenery;

! --- Scenery: Clinic ---
Object clinic_gurneys "medical equipment" clinic
    with name 'gurneys' 'gurney' 'equipment' 'medical' 'vials' 'tubing',
         description "Overturned gurneys, shattered vials, and coils of surgical tubing litter the floor. Whatever NeoMed Solutions was before it closed, someone repurposed it for something far worse.",
    has scenery pluralname;

Object clinic_chair "reclined chair" clinic
    with name 'chair' 'reclined',
         description [;
             if (lily_freed) {
                 print "The reclined chair sits empty, its leather surface still bearing the impression of Lily's body. Disconnected electrode pads dangle from the headrest.^";
                 rtrue;
             }
             print "A medical reclining chair with Lily strapped into it. Electrode pads are attached to her temples, connecting her to the neural interface rig.^";
             rtrue;
         ],
    has scenery;

Object rig "neural interface rig" clinic
    with name 'rig' 'neural' 'interface' 'machine' 'cables' 'electrodes',
         description [;
             if (lily_freed) {
                 print "The neural interface rig sits dead and silent. Disconnected cables dangle from the headrest, their electrode tips dark. The green circuitry has gone black, the sickly hum replaced by nothing but the drip of condensation somewhere in the walls.^";
                 rtrue;
             }
             print "A nightmarish tangle of cables, electrodes, and pulsing green circuitry. The rig hums with a low, sickly vibration. Lily is connected to it by a web of wires snaking into her temples.^";
             rtrue;
         ],
    has scenery;

! --- Scenery: Server Room ---
Object server_racks "server racks" server
    with name 'racks' 'rack' 'servers',
         description "Rows of humming server racks stretch from floor to ceiling, each one packed with blinking hardware. The combined heat output is considerable despite the industrial cooling. Somewhere in these machines, Zheng-Harmon's darkest secrets are stored.",
    has scenery pluralname;

Object server_fans "cooling fans" server
    with name 'fans' 'fan' 'cooling' 'drone',
         description "Industrial cooling fans embedded in the ceiling and walls churn relentlessly, fighting to keep the server racks from overheating. Their combined drone fills the room with a constant mechanical hum that vibrates in your teeth.",
    has scenery pluralname;

Object server_leds "LEDs" server
    with name 'leds' 'led' 'lights',
         description "Red LEDs blink in rhythmic patterns along each server rack, like the heartbeats of sleeping machines. Occasionally one flickers amber -- a drive working overtime, or maybe a warning nobody will ever read.",
    has scenery pluralname;

Object neural_jack "neural jack point" server
    with name 'jack' 'point' 'port' 'chrome',
         description "A chrome neural interface port protruding from the main server console. You could jack in to access the server's data directly through cyberspace.",
    has scenery;

Object data_console "data console" server
    with name 'console' 'data' 'drive' 'server',
         description "The main server console hums with activity. A neural jack point protrudes from its surface -- the only way to access the data locked behind Zheng-Harmon's military-grade ICE.",
         before [;
           Take:
             print "The data is locked behind military-grade ICE. You'll need to jack into the server's neural interface to access it through cyberspace.^";
             rtrue;
         ],
    has scenery;

! --- Scenery: Cyberspace ---
Object cyber_structures "crystalline structures" cyber_lobby
    with name 'crystalline' 'structures' 'towers' 'crystal',
         description "Towering crystalline structures rise around you -- the server's architecture rendered as geometry in cyberspace. Each facet contains flickering data: file directories, access logs, encrypted vaults. The structures pulse with cold neon light. A stray process labeled ~WINTERMUTE~ drifts between the towers like a ghost, its purpose long forgotten.",
    has scenery pluralname;

Object ice_wall "ICE wall" cyber_lobby
    with name 'ice' 'wall' 'firewall' 'barrier' 'countermeasures',
         description [;
             if (ice_bypassed) {
                 print "The ICE wall lies in shattered fragments, its red glow fading to nothing. The path north to the data vault is clear.^";
                 rtrue;
             }
             if (ice_analyzed) {
                 print "A massive wall of shimmering red energy blocks the path north. Now that you've analyzed its architecture, you can see the hairline fracture in the security lattice -- a buffer overflow in an unpatched module. You need an exploit to crack it open. Try scanning the data streams for usable code.^";
                 rtrue;
             }
             print "A massive wall of shimmering red energy blocks the path north. Military-grade Intrusion Countermeasure Electronics -- Zheng-Harmon's finest. The patterns shift and pulse like a living thing. Try scanning it to find a weakness.^";
             rtrue;
         ],
    has scenery;

Object data_streams "data streams" cyber_lobby
    with name 'data' 'streams' 'rivers' 'code',
         description [;
             if (ice_exploit_ready) {
                 print "Rivers of luminous code flow beneath you. You've already extracted an exploit sequence from the stream -- your neural implant is primed and ready to deploy it against the ICE wall.^";
                 rtrue;
             }
             if (ice_analyzed) {
                 print "Rivers of luminous code flow beneath you, carrying fragments of corporate data. Now that you know the ICE's weakness, you might be able to scan the streams for a matching exploit sequence.^";
                 rtrue;
             }
             print "Rivers of luminous code flow beneath you, carrying fragments of corporate data -- financial records, employee files, research notes. The experiment logs you need are locked behind the ICE to the north.^";
             rtrue;
         ],
    has scenery pluralname;

Object vault_entrance "data vault" cyber_lobby
    with name 'vault' 'data',
         description [;
             if (ice_bypassed) {
                 print "The shattered remnants of the ICE wall flicker around the entrance to the data vault. The path north is wide open.^";
                 rtrue;
             }
             print "The data vault lies beyond the ICE wall to the north, inaccessible until the military-grade firewall is breached.^";
             rtrue;
         ],
         before [;
           Enter:
             if (ice_bypassed) {
                 PlayerTo(cyber_vault);
                 rtrue;
             }
             print "A wall of shimmering red ICE blocks your path. Military-grade intrusion countermeasures -- one wrong move and it could fry your neural implant. You need to hack through it first.^";
             rtrue;
         ],
    has scenery;

Object vault_columns "data columns" cyber_vault
    with name 'columns' 'column' 'pillars' 'pillar',
         description "Columns of encrypted data rise like pillars into an infinite digital sky, each one containing terabytes of corporate information. The encryption patterns shimmer and shift, but with the ICE down, the data is exposed.",
    has scenery pluralname;

Object data_node "data node" cyber_vault
    with name 'node' 'data',
         description "A pulsing sphere of light containing Zheng-Harmon's experiment logs. Unprotected now that the ICE is down, you can download its contents directly into your neural implant.",
         before [;
           Take:
             found_logs = true;
             score = score + 20;
             move logs to player;
             print "You reach into the data node, your neural implant interfacing directly with the raw data. The experiment logs flood into your consciousness -- horrifying records of neural experiments on human subjects. Among the files you find coordinates for an abandoned clinic in the industrial district, along with a door code: 7749.^^The data extracted, cyberspace dissolves around you. Your eyes snap open in the server room, the neural jack disconnecting with a soft click.^";
             jacked_in = false;
             PlayerTo(server);
             rtrue;
         ];

! --- Scenery: Industrial District ---
Object industrial_factories "factories" industrial
    with name 'factories' 'factory' 'buildings',
         description "Dark factories loom against the neon sky like the bones of dead giants. Their windows are dark, their smokestacks cold. Whatever they once manufactured, the machines fell silent years ago. You can just make out ~KANEDA HEAVY INDUSTRIES~ stenciled on the nearest loading bay.",
    has scenery pluralname;

Object industrial_conveyors "conveyor belts" industrial
    with name 'conveyor' 'conveyors' 'belts' 'belt',
         description "Broken conveyor belts rust in the rain, their rubber surfaces cracked and peeling. Scattered along them are fragments of discarded tech -- circuit boards, cable bundles, cracked screens.",
    has scenery pluralname;

Object dumpster "rusty dumpster" industrial
    with name 'dumpster' 'rusty',
         description "A rusted-out industrial dumpster, half-blocking an alley entrance to the east. It reeks of chemical waste and old machine oil.",
    has scenery;

Object neomed_sign "faded sign" industrial
    with name 'sign' 'faded',
         description "A weather-beaten sign that reads ~NeoMed Solutions~ in faded letters. The company went under years ago, but the clinic building remains.",
    has scenery;

Object clinic_door "clinic door" industrial
    with name 'door' 'clinic' 'lock' 'keypad',
         description "The keypad requires a 4-digit code. The answer must be somewhere in Zheng-Harmon's records.",
    has scenery;

! --- Objects in Office ---
Object desk "desk" office
    with name 'desk' 'drawer',
         description "A cramped metal desk, cluttered with case files and empty synth-whiskey bottles. A small drawer is set into the front.",
    has scenery container openable;

Object datapad "datapad" office
    with name 'datapad' 'data' 'pad',
         description "Lily Chen's encrypted datapad. The screen flickers with data about a neural experiment.",
         before [;
           Examine:
             print "Lily Chen's encrypted datapad. The screen flickers with data about a neural experiment.^";
             print "A small indicator in the corner reads: [SATS ", player_sats, "]^";
             rtrue;
         ];

Object pistol "pistol" desk
    with name 'pistol' 'sidearm' 'gun',
         description "A standard issue sidearm. Loaded, just in case.";

Object whiskey "bottle of synth-whiskey" office
    with name 'bottle' 'whiskey' 'synth-whiskey',
         description "Half-empty bottle of expensive synth-whiskey. The label reads ~Deckard's Reserve~ in peeling gold foil.",
         before [;
           Drink:
             print "You take a long pull of Deckard's Reserve. It burns going down -- cheap synth pretending to be top shelf. But tonight, it tastes like the truth: bitter and necessary.^";
             rtrue;
         ];

! --- Pistol Reminder Daemon ---
Object pistol_reminder
    with daemon [;
             if (pistol in player) {
                 StopDaemon(self);
                 return;
             }
             turns_since_left++;
             if (turns_since_left == 10 && pistol_reminder_count == 0) {
                 pistol_reminder_count = 1;
                 print "^Your neural implant prickles again -- a nagging buzz at the base of your skull. You left something behind at the office. Something you might need before this is over.^";
             }
             if (turns_since_left == 25 && pistol_reminder_count == 1) {
                 pistol_reminder_count = 2;
                 print "^Your neural implant flares -- a sharp jolt this time, urgent and insistent. Whatever you forgot at the office, your subconscious is screaming at you to go back for it. Now.^";
                 StopDaemon(self);
             }
         ];

! --- NPCs (refactored to use centralized conversation handlers) ---
Object kai "Kai Chen" office
    with name 'kai' 'chen' 'man' 'client' 'father',
         description "A desperate man in a rumpled suit -- expensive once, maybe last season, but now creased from days of wear. The collar is loosened, the tie yanked halfway down his chest. A cheap neural patch glows amber behind his left ear, the kind the clinics sell for anxiety. It isn't working. His eyes are sunken and bloodshot, ringed with dark circles that speak of sleepless nights spent staring at his comm terminal, willing it to ring. His hands tremble around a cup of cold tea you offered him twenty minutes ago. He hasn't touched it. A wedding band catches the light on his left hand -- scratched, well-worn, the ring of a man who still believes in something. Everything about him says mid-level corporate, respectable, the kind of father who coaches little league on weekends. And everything about the way he's sitting -- hunched forward, jaw clenched, barely holding it together -- says his world has just caved in.",
         life [;
           Ask:
             NPC_Ask_Kai(second);
             rtrue;
           Tell:
             print "Kai listens anxiously, hanging on your every word.^";
             rtrue;
           Give:
             print "Kai waves it away. ~I don't need that. I need you to find Lily.~^";
             rtrue;
         ],
    has animate proper;

Object raven "Raven" bar
    with name 'raven' 'bartender',
         initial "Behind the counter, the bartender called Raven polishes a glass with a stained rag, her cybernetic left eye casting a faint blue glow across the scarred wood. A tattoo of a raven in flight adorns the left side of her neck. She watches you walk in with the calculating look of someone who already knows what you want -- and how much it's going to cost.",
         description "The bartender. Tall, imposing, with a cybernetic left eye that glows faintly blue. A tattoo of a raven in flight covers the left side of her neck. She watches you with naked calculation.",
         life [;
           Ask:
             NPC_Ask_Raven(second);
             rtrue;
           Tell:
             print "Raven nods, barely listening.^";
             rtrue;
           Give:
             print "Raven pushes it back. ~I don't want your junk, sweetheart. I deal in satoshis.~^";
             rtrue;
         ],
    has animate proper female;

Object zephyr "Zephyr" den
    with name 'zephyr' 'hacker',
         description "A wiry figure hunched over a keyboard, their face lit by the glow of a dozen screens. Fiber-optic cables are spliced directly into the ports behind their ears.",
         life [;
           Ask:
             NPC_Ask_Zephyr(second);
             rtrue;
           Tell:
             print "Zephyr nods absently.^";
             rtrue;
           Give:
             if (noun == datapad) {
                 if (knows_zephyr == false) {
                     print "Zephyr doesn't even look up. ~I don't work with strangers. Get a referral.~^";
                     rtrue;
                 }
                 remove datapad;
                 zephyr_helped = true;
                 has_keycard = true;
                 score = score + 20;
                 print "Zephyr grabs the datapad and plugs it into the rig. Fingers fly across keys.^";
                 print "~I'm only doing this because I owe Raven a favor.~ A pause. ~Decrypted. Zheng-Harmon Corp is running neural experiments.~^";
                 print "He slides a platinum keycard across the desk. ~Cloned this from the data. It'll get you into the Zheng-Harmon executive floor. Go south from the street to the lobby and use it.~^^";
                 print "[You now have the keycard.]^";
                 move keycard to player;
                 rtrue;
             }
             print "Zephyr waves it off. ~I need data, not junk.~^";
             rtrue;
           Show:
             print "Zephyr barely glances at it.^";
             rtrue;
         ],
    has animate proper;


Object tanaka "Detective Tanaka" precinct
    with name 'tanaka' 'detective' 'cop',
         description "A bored-looking cop with a gut and a lazy eye. His desk is covered in takeout containers and cold case files that will never be opened again.",
         life [;
           Ask:
             NPC_Ask_Tanaka(second);
             rtrue;
           Tell:
             print "Tanaka yawns and reaches for his coffee.^";
             rtrue;
         ],
    has animate proper;

Object guard "Security Guard" lobby
    with name 'guard' 'security',
         description "Armored and armed, the guard blocks the elevator with impassive neutrality.",
         life [;
           Show:
             if (noun == keycard) {
                 has_keycard = true;
                 print "The guard examines your keycard, nods, and steps aside. The elevator is now accessible.^";
                 rtrue;
             }
             print "The guard is unimpressed.^";
             rtrue;
           Give:
             if (noun == keycard) {
                 has_keycard = true;
                 print "The guard scans your keycard and steps aside. ~Elevator's clear.~^";
                 rtrue;
             }
             print "The guard pushes it back. ~I don't want that.~^";
             rtrue;
           Ask:
             NPC_Ask_Guard(second);
             rtrue;
           Tell:
             print "The guard ignores you.^";
             rtrue;
         ],
    has animate proper;

Object lily "Lily Chen" clinic
    with name 'lily' 'chen' 'woman' 'daughter',
         description [;
             if (lily_freed) {
                 print "Lily looks shaken but determined. She stays close to you, eyes darting nervously at every shadow.^";
                 rtrue;
             }
             print "A young woman, pale and unconscious, connected to the neural rig. She looks terrified even in unconsciousness.^";
             rtrue;
         ],
         life [;
           Ask:
             NPC_Ask_Lily(second);
             rtrue;
           Tell:
             if (lily_freed == false) {
                 print "Lily is unconscious. She can't hear you.^";
                 rtrue;
             }
             print "Lily listens intently, nodding. ~I believe you, Vex. After what I've been through, nothing surprises me anymore.~^";
             rtrue;
           Give:
             if (lily_freed == false) {
                 print "Lily is unconscious. She can't take anything right now.^";
                 rtrue;
             }
             print "Lily shakes her head. ~Hold onto that, Vex. You might need it more than I do.~^";
             rtrue;
         ],
         daemon [;
             if (lily_freed) {
                 if (location == rooftop && voss_phase == 0) return;
                 if (lily_sacrificed) return;
                 move self to location;
             }
         ],
    has animate proper female;

! --- Keycard ---
Object keycard "keycard"
    with name 'keycard' 'card' 'key',
         description "A platinum access keycard for Zheng-Harmon executive floors.",
         before [;
           Insert:
             if (location == executive && second == sec_terminal) {
                 if (server_unlocked) {
                     print "The security terminal already shows ACCESS GRANTED.^";
                     rtrue;
                 }
                 server_unlocked = true;
                 print "You slide the keycard into the security terminal. The screen flickers, cycles through authentication protocols, then flashes green: ACCESS GRANTED. The reinforced door to the east clicks unlocked.^";
                 rtrue;
             }
         ];

! --- Experiment Logs ---
Object logs "experiment logs"
    with name 'logs' 'experiment' 'log',
         description "Experiment logs detailing neural experiments on human subjects. The clinic location in the industrial district is mentioned repeatedly. Among the files you find coordinates for an abandoned clinic in the industrial district, along with a door code: 7749.",
         before [;
           Take:
             if (location == server) {
                 print "The data is locked behind military-grade ICE. You'll need to jack into the server's neural interface to access it through cyberspace.^";
                 rtrue;
             }
         ]
    has pluralname;

! --- Voss on rooftop (separate instance for final encounter) ---
Object rooftop_voss "Director Voss" rooftop
    with name 'voss' 'director',
         description [;
             if (voss_phase == 0)
                 "Voss stands near the edge, silenced pistol raised. His eyes are wild.";
             if (voss_phase == 1)
                 "Voss is backing toward the helicopter, pistol trained on you. Blood runs from a gash on his temple where your first shot grazed him.";
             "Voss is distracted by Lily, his aim wavering. Now is your chance.";
         ],
         life [;
           Attack:
             if (pistol notin player) {
                 print "You need a weapon first.^";
                 rtrue;
             }
             ! Phase 0: First shot - Voss fires back
             if (voss_phase == 0) {
                 voss_phase = 1;
                 voss_turn_count = 0;
                 StartDaemon(rooftop_voss);
                 print "You raise your pistol and fire. The shot grazes Voss's temple -- blood sprays across his face. But he's fast. His silenced pistol coughs twice and white-hot pain explodes in your left shoulder.^^";
                 print "You stagger, clutching the wound. Voss wipes blood from his eyes, snarling. ~You should have stayed out of this, detective!~ He starts backing toward the helicopter on the helipad, keeping his gun trained on you.^";
                 if (lily_freed) {
                     print "^Behind you, footsteps pound up the stairwell. Lily bursts onto the rooftop. ~Vex! I'm coming!~^";
                 }
                 rtrue;
             }
             ! Phase 1 without Lily: Player takes a risky second shot
             if (voss_phase == 1 && lily_freed == false) {
                 voss_dead = true;
                 score = score + 20;
                 StopDaemon(rooftop_voss);
                 remove rooftop_voss;
                 print "You grit your teeth against the pain and raise your pistol with your good arm. Voss sees you aim and fires -- the bullet whips past your ear. You squeeze the trigger.^^";
                 print "The shot takes Voss in the chest. He stumbles backward, hits the rooftop railing, and crumples to the ground. His pistol clatters away into the rain.^^";
                 print "You stand over him as the light fades from his eyes. ~It's over, Voss.~^^";
                 print "He tries to speak, blood bubbling on his lips, but no words come. The rain washes it all away.^";
                 rtrue;
             }
             ! Phase 1 with Lily: Lily just arrived - shooting now means she's in the crossfire
             if (voss_phase == 1 && lily_freed) {
                 voss_dead = true;
                 lily_sacrificed = true;
                 score = score + 10;
                 StopDaemon(rooftop_voss);
                 remove rooftop_voss;
                 print "You raise your pistol and fire. Voss fires at the same instant -- but Lily has thrown herself forward, trying to tackle him. His bullet catches her in the chest instead of you.^^";
                 print "Your shot hits Voss square in the throat. He drops like a puppet with cut strings. But Lily --^^";
                 print "She lies on the rain-slicked concrete, eyes wide, a red bloom spreading across her shirt. ~V-Vex...~ she whispers. ~Did we... get him?~^^";
                 print "~We got him,~ you say, kneeling beside her, pressing your hands to the wound. But you already know. You've seen enough death to recognize it.^^";
                 print "~Tell my father...~ She doesn't finish. The rain keeps falling.^^";
                 print "You brought down Director Voss. But the cost... the cost was too high. Lily Chen is dead, and no amount of justice will bring her back.^";
                 deadflag = 2;
                 rtrue;
             }
             ! Phase 2: Lily is distracting Voss - clean shot
             if (voss_phase == 2) {
                 voss_dead = true;
                 score = score + 20;
                 StopDaemon(rooftop_voss);
                 remove rooftop_voss;
                 print "With Lily distracting Voss, you have a clear shot. You steady your wounded arm, take aim, and squeeze the trigger.^^";
                 print "The bullet takes Voss in the chest. His eyes go wide with shock. The silenced pistol tumbles from his fingers and he collapses onto the wet concrete, the helicopter's rotors still spinning uselessly behind him.^^";
                 print "Lily rushes to your side. ~Is it over?~^^";
                 print "~It's over,~ you say. The rain keeps falling, but for the first time in weeks, it feels clean.^^";
                 print "Congratulations! You've saved Lily Chen and brought down Director Voss. The city won't change overnight, but tonight, justice won. You won.^";
                 deadflag = 2;
                 rtrue;
             }
             rtrue;
           Ask:
             NPC_Ask_RooftopVoss(second);
             rtrue;
         ],
         daemon [;
             if (location ~= rooftop) return;
             if (voss_dead || voss_escaped) {
                 StopDaemon(self);
                 return;
             }
             voss_turn_count++;
             ! Phase 1 with Lily: after 1 turn, Lily steps forward to distract (phase 2)
             if (voss_phase == 1 && lily_freed && voss_turn_count >= 2) {
                 voss_phase = 2;
                 voss_turn_count = 0;
                 print "^Lily steps forward, putting herself between you and Voss. ~Director Voss!~ she shouts over the wind. ~I know what you did! The experiments, the test subjects -- I remember ALL of it!~^^";
                 print "Voss's pistol wavers, his attention split. ~You -- you were supposed to be wiped! How do you remember?!~^^";
                 print "This is your chance. Take the shot while he's distracted!^";
                 return;
             }
             ! Phase 1 without Lily: after 3 turns, Voss escapes
             if (voss_phase == 1 && lily_freed == false && voss_turn_count >= 3) {
                 voss_escaped = true;
                 StopDaemon(self);
                 remove rooftop_voss;
                 score = score + 5;
                 print "^Voss reaches the helicopter. The rotors scream to life, whipping rain sideways across the rooftop. He hauls himself into the cockpit, blood streaming from the gash on his temple.^^";
                 print "~This isn't over, detective!~ he screams over the engine. The helicopter lifts off, swaying in the gale, and disappears into the storm.^^";
                 print "You stand on the empty rooftop, wounded and alone. Voss is gone. You found the evidence, exposed the experiments -- but the man responsible is still out there, somewhere above the clouds. A partial victory, at best.^";
                 deadflag = 2;
                 rtrue;
             }
             ! Phase 2: after 2 turns without shooting, Voss escapes (Lily safe)
             if (voss_phase == 2 && voss_turn_count >= 2) {
                 voss_escaped = true;
                 StopDaemon(self);
                 remove rooftop_voss;
                 score = score + 5;
                 print "^Voss shoves Lily aside and sprints for the helicopter. You try to aim but the pain in your shoulder is blinding. The rotors scream to life.^^";
                 print "~Next time, detective!~ Voss screams from the cockpit. The helicopter lifts off into the storm and vanishes.^^";
                 print "Lily grabs your arm. ~He's gone,~ she says, rain streaming down her face. ~But we have the evidence. We have everything we need to bring Zheng-Harmon down.~^^";
                 print "She's right. Voss escaped, but Lily is alive and the truth is out. It's not the ending you wanted, but it's an ending. Sometimes that has to be enough.^";
                 deadflag = 2;
                 rtrue;
             }
         ],
    has animate proper;

! --- Status Line (proper window management for frotz) ---
[ DrawStatusLine width posa posb;
    @set_window 1;
    @set_cursor 1 1;
    style reverse;
    width = 0->33;
    spaces width;
    @set_cursor 1 1;
    print " ", (name) location;
    posb = width - 1;
    posa = posb - 20;
    @set_cursor 1 posa;
    print "SATS:", player_sats, " | Score:", score, "/", MAX_SCORE, " ";
    style roman;
    @set_window 0;
];

! --- BeforeParsing: rewrite "pay" to "zpy" before the parser sees it ---
! 'pay' is a synonym of 'give' in Grammar.h and Extend 'pay' replace
! cannot detach it.  Rewriting to 'zpy' routes through Verb 'zpy'
! which maps cleanly to PaySub with no implicit-take issues.
[ BeforeParsing i len w;
    wn = 1;
    w = NextWord();
    if (w == 'pay') {
        i = WordAddress(1);
        i->0 = 'z';
        i->1 = 'p';
        i->2 = 'y';
        Tokenise__(buffer, parse);
    }
    if (w == 'jack') {
        i = WordAddress(1);
        len = WordLength(1);
        i->0 = 'z';
        i->1 = 'j';
        i->2 = 'k';
        if (len > 3) i->3 = ' ';
        Tokenise__(buffer, parse);
    }
    if (w == 'scan' or 'analyze' or 'probe') {
        i = WordAddress(1);
        len = WordLength(1);
        i->0 = 'z';
        i->1 = 's';
        i->2 = 'c';
        while (len > 3) { len--; i->len = ' '; }
        Tokenise__(buffer, parse);
    }
    if (w == 'hack' or 'bypass') {
        i = WordAddress(1);
        len = WordLength(1);
        i->0 = 'z';
        i->1 = 'h';
        i->2 = 'k';
        while (len > 3) { len--; i->len = ' '; }
        Tokenise__(buffer, parse);
    }
    if (w == 'disconnect') {
        i = WordAddress(1);
        len = WordLength(1);
        i->0 = 'z';
        i->1 = 'd';
        i->2 = 'c';
        while (len > 3) { len--; i->len = ' '; }
        Tokenise__(buffer, parse);
    }
    rfalse;
];

! --- Initialization ---
[ Initialise;
    location = office;
    score = 0;

    print "^^You're Kira Vex, private eye. In this city, that means you're either brave or stupid -- most days, you're not sure which.^";
    print "^Neo-Angeles sprawls beneath a sky that hasn't shown stars in years. The megacorps own everything above the fortieth floor; below that, it's neon, rain, and people trying to survive until tomorrow. You've carved out a life in the margins -- tracking down missing persons, pulling secrets out of corporate databases, occasionally convincing yourself you're making a difference.^";
    print "^The rain hasn't stopped in three days. It hammers against your office window in sheets, turning the street below into a river of reflected neon. Your coffee went cold an hour ago. The heater died last week. The landlord wants three months' back rent, and your last client paid in expired chits.^";
    print "^But none of that matters right now, because Kai Chen is sitting across from you, and the look on his face says this isn't a cheating-spouse case.^^";
    print "Type 'help' to pull up your PI field manual.^^";
];

! --- Help command ---
[ HelpSub;
    print "^=== KIRA VEX -- PI FIELD MANUAL ===^";
    print "   (dog-eared, coffee-stained, still useful)^^";

    print "[NAVIGATION PROTOCOLS]^";
    print "  north / south / east / west / up / down^";
    print "  -- Standard compass nav. This city's a grid, mostly.^";
    print "  -- Some exits aren't obvious. Read the room.^^";

    print "[INVESTIGATION OPS]^";
    print "  look ............. Scan your surroundings. Do it often.^";
    print "  examine X ........ Get a closer read on something -- or someone.^";
    print "  take X ........... Pocket it. You never know what's evidence.^";
    print "  inventory ........ Check what you're carrying.^";
    print "  open X ........... Drawers, containers, whatever isn't nailed shut.^^";

    print "[INTERPERSONAL INTERFACE]^";
    print "  talk to X ........ Start a conversation. Keep it casual.^";
    print "  ask X about Y .... Dig for specifics. Names, corps, events.^";
    print "  give/hand X to Y .. Grease palms. Information has a price.^";
    print "  pay X ............ Digital transfer. Use the datapad.^";
    print "  show X to Y ...... Flash credentials or evidence.^^";

    print "[SPECIAL ACTIONS]^";
    print "  shoot X .......... Last resort. Requires a loaded weapon.^";
    print "  free X ........... Disconnect someone from hostile tech.^";
    print "  use X ............ Deploy keycards, tools, whatever fits.^";
    print "  jack in .......... Interface with a neural jack point.^";
    print "  scan X ........... Analyze cyberspace objects for weaknesses.^";
    print "  hack ............. Breach ICE defenses in cyberspace.^";
    print "  disconnect ....... Jack out of cyberspace.^^";

    print "[SYSTEM]^";
    print "  quit ............. Walk away from the case. Not recommended.^";
    print "  save / restore ... Checkpoint your progress. Trust nobody,^";
    print "                     not even autosave.^^";

    print "Remember, Vex: everybody lies, nothing is free,^";
    print "and the rain never stops.^";
];

! --- Talk To action (refactored to dispatch to NPC routines) ---
[ TalkToSub;
    if (noun == kai)              { NPC_Talk_Kai(); rtrue; }
    if (noun == raven)            { NPC_Talk_Raven(); rtrue; }
    if (noun == zephyr)           { NPC_Talk_Zephyr(); rtrue; }
    if (noun == tanaka)           { NPC_Talk_Tanaka(); rtrue; }
    if (noun == guard)            { NPC_Talk_Guard(); rtrue; }
    if (noun == bolt)             { NPC_Talk_Bolt(); rtrue; }
    if (noun == lily)             { NPC_Talk_Lily(); rtrue; }
    if (noun == rooftop_voss) { NPC_Talk_RooftopVoss(); rtrue; }
    if (noun has animate) {
        if (noun has pluralname)
            print (The) noun, " don't seem interested in talking.^";
        else
            print (The) noun, " doesn't seem interested in talking.^";
        rtrue;
    }
    print "You can't talk to that.^";
];

! --- Shoot action ---
[ ShootSub;
    if (pistol notin player) {
        print "You don't have a weapon.^";
        rtrue;
    }
    if (noun == rooftop_voss) {
        ! Delegate to the Attack life handler on rooftop_voss
        <Attack rooftop_voss>;
        rtrue;
    }
    print "You're not going to shoot that.^";
];

! --- Free/Rescue action ---
[ FreeSub;
    if (noun == lily) {
        if (lily_freed) {
            print "You've already freed Lily.^";
            rtrue;
        }
        if (location == clinic) {
            lily_freed = true;
            score = score + 20;
            StartDaemon(lily);
            print "You disconnect the neural interface cables. Lily gasps, eyes fluttering open.^";
            print "~Who... where am I?~ She looks up at you with frightened eyes.^";
            print "~You're safe now,~ you say. ~I'm getting you out of here.~^";
            if (voss_dead) {
                print "^^Congratulations! You've rescued Lily and Voss is dead. Victory is yours.^";
                deadflag = 2;
            }
            if (voss_escaped) {
                print "^^Voss escaped into the storm, but Lily is safe. You have the evidence to bring Zheng-Harmon down. A partial victory.^";
                deadflag = 2;
            }
            rtrue;
        }
        print "Lily isn't here.^";
        rtrue;
    }
    print "You can't free that.^";
];

! --- Pay action ---
[ PaySub;
    if (noun == raven) {
        if (raven_paid) {
            print "Raven waves you off. ~We're square, sweetheart. Go find Zephyr.~^";
            rtrue;
        }
        if (datapad notin player) {
            print "Raven smirks. ~You don't even have the datapad to transfer with, sweetheart. Maybe check your desk back at the office?~^";
            rtrue;
        }
        if (player_sats <= 0) {
            print "Raven checks the transfer screen and shakes her head. ~You're broke, sweetheart. Come back when you've got satoshis.~^";
            rtrue;
        }
        player_sats = player_sats - 50;
        raven_paid = true;
        knows_zephyr = true;
        score = score + 10;
        print "You tap your datapad. Fifty satoshis transfer to Raven's account. She glances at the confirmation and leans close. ~You want info? Talk to Zephyr, a hacker down in the Chinatown alley. Go east from the street, then south. Tell 'em Raven sent you.~^";
        rtrue;
    }
    if (noun has animate) {
        print (The) noun, " doesn't want your money.^";
        rtrue;
    }
    print "You can't pay that.^";
];

! --- Use Keycard action ---
[ UseCardSub;
    if (noun == keycard) {
        if (location == lobby) {
            has_keycard = true;
            print "You swipe the keycard. The elevator doors open with a chime. You can go up now.^";
            rtrue;
        }
        if (location == executive) {
            if (server_unlocked) {
                print "The security terminal already shows ACCESS GRANTED.^";
                rtrue;
            }
            server_unlocked = true;
            print "You slide the keycard into the security terminal. The screen flickers, cycles through authentication protocols, then flashes green: ACCESS GRANTED. The reinforced door to the east clicks unlocked.^";
            rtrue;
        }
        print "There's nothing to use the keycard on here.^";
        rtrue;
    }
    print "You can't use that.^";
];

! --- Jack In action ---
[ JackInSub;
    if (location ~= server) {
        print "There's no neural interface to jack into here.^";
        rtrue;
    }
    if (found_logs) {
        print "You've already extracted the data from this server. No need to jack in again.^";
        rtrue;
    }
    jacked_in = true;
    print "You press your neural implant against the chrome jack point. A jolt of electricity arcs through your skull as the connection initializes. Reality dissolves into cascading lines of code...^^";
    PlayerTo(cyber_lobby);
    rtrue;
];

! --- Scan action (cyberspace analysis) ---
[ ScanSub;
    if (location ~= cyber_lobby) {
        print "There's nothing to scan here.^";
        rtrue;
    }
    if (ice_bypassed) {
        print "The ICE is already down. There's nothing left to scan.^";
        rtrue;
    }
    if (noun == ice_wall || noun == nothing) {
        if (ice_analyzed) {
            print "You've already mapped the ICE's vulnerability -- a buffer overflow in an unpatched security module. Now you need an exploit to crack it. Try scanning the data streams.^";
            rtrue;
        }
        ice_analyzed = true;
        score = score + 5;
        print "You focus your neural implant on the ICE wall, letting your consciousness split into parallel threads to map its architecture. Layer by layer, the firewall's structure reveals itself -- adaptive encryption, rotating cipher keys, self-healing code matrices. But there, deep in the lattice, you spot it: a hairline fracture. A buffer overflow in an unpatched security module.^^You've found the weakness, but you'll need an exploit to crack it open. The data streams flowing through cyberspace might contain usable code.^";
        rtrue;
    }
    if (noun == data_streams) {
        if (ice_analyzed == false) {
            print "Rivers of code flow past, but without knowing what you're looking for, the data is meaningless noise. Try scanning the ICE wall first to identify a vulnerability.^";
            rtrue;
        }
        if (ice_exploit_ready) {
            print "Your neural implant is already loaded with the exploit sequence. You're ready to hack the ICE.^";
            rtrue;
        }
        ice_exploit_ready = true;
        score = score + 5;
        print "You plunge your awareness into the data streams, sifting through torrents of corporate code. Financial records, personnel files, security patches -- there. A fragment of an old penetration test, buried in a forgotten QA directory. It targets exactly the buffer overflow vulnerability you found in the ICE.^^Your neural implant absorbs the exploit sequence, compiling it into a ready-to-deploy payload. You're armed and ready -- hack the ICE wall to bring it down.^";
        rtrue;
    }
    print "You scan it, but find nothing useful. Try scanning the ICE wall or the data streams.^";
    rtrue;
];

! --- Hack ICE action ---
[ HackICESub;
    if (location ~= cyber_lobby) {
        print "There's nothing to hack here.^";
        rtrue;
    }
    if (ice_bypassed) {
        print "The ICE is already down. The path north is clear.^";
        rtrue;
    }
    if (ice_analyzed == false) {
        print "You throw yourself at the ICE wall, neural implant blazing -- but the military-grade firewall deflects every probe. You're attacking blind. You need to scan the ICE first and find a vulnerability before you can break through.^";
        rtrue;
    }
    if (ice_exploit_ready == false) {
        print "You found the weakness in the ICE -- a buffer overflow in an unpatched module -- but you don't have an exploit to drive through the crack. Try scanning the data streams for usable attack code.^";
        rtrue;
    }
    ice_bypassed = true;
    print "You deploy the exploit sequence against the ICE wall's buffer overflow. Your neural implant drives the payload deep into the security lattice, thread by thread unraveling the firewall from the inside. The military-grade ICE fights back -- your vision blurs, pain lancing through your temples -- but the exploit holds. The crack widens, fractures spiderwebbing across the red wall of energy.^^The ICE wall shatters like red glass, fragments dissolving into nothing. The path to the data vault is open.^";
    rtrue;
];

! --- Disconnect action ---
[ DisconnectSub;
    if (noun) {
        print "To disconnect Lily from the neural rig, try ~free lily~.^";
        rtrue;
    }
    if (location ~= cyber_lobby && location ~= cyber_vault) {
        print "You're not jacked into anything.^";
        rtrue;
    }
    jacked_in = false;
    print "You trigger the disconnect sequence. Cyberspace dissolves around you in a cascade of fading pixels. Your eyes snap open in the server room, the neural jack disconnecting with a soft click.^";
    PlayerTo(server);
    rtrue;
];

Include "Grammar";

! --- Custom verb definitions ---
Verb 'help'
    *                                               -> Help;

Verb 'talk'
    * 'to' creature                             -> TalkTo;

Verb 'shoot'
    * creature                                  -> Shoot;

Verb 'free' 'rescue'
    * noun                                      -> Free;

Extend 'save' first
    * noun                                      -> Free;

Verb 'zpy'
    * creature                                  -> Pay;

Extend 'give' first
    * held 'to' creature                        -> Give;

Verb 'hand'
    * held 'to' creature                        -> Give;

Verb 'use'
    * noun                                      -> UseCard;

Extend 'insert' first
    * held                                      -> UseCard;

Verb 'zjk'
    *                                           -> JackIn
    * 'in'                                      -> JackIn;

Verb 'zsc'
    *                                           -> Scan
    * noun                                      -> Scan;

Verb 'zhk'
    *                                           -> HackICE
    * noun                                      -> HackICE;

Verb 'zdc'
    *                                           -> Disconnect
    * noun                                      -> Disconnect;
