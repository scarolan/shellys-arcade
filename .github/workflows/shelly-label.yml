name: Auto-label for Shelly

on:
  projects_v2_item:
    types: [edited]

jobs:
  label-for-shelly:
    runs-on: ubuntu-latest
    if: github.event.changes.field_value.field_name == 'Pipeline'
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const newValue = context.payload.changes.field_value.to?.name;
            const item = context.payload.projects_v2_item;
            const contentId = item.content_node_id;
            const contentType = item.content_type;

            if (contentType \!== "Issue") return;

            // Get issue details from node ID
            const { node } = await github.graphql(`
              query($id: ID\!) {
                node(id: $id) {
                  ... on Issue {
                    number
                    repository { owner { login } name }
                    labels(first: 10) { nodes { name } }
                  }
                }
              }
            `, { id: contentId });

            const owner = node.repository.owner.login;
            const repo = node.repository.name;
            const issueNumber = node.number;
            const hasLabel = node.labels.nodes.some(l => l.name === "shelly");

            if (newValue === "Ready for Shelly" && \!hasLabel) {
              await github.rest.issues.addLabels({
                owner, repo,
                issue_number: issueNumber,
                labels: ["shelly"]
              });
              console.log(`Added shelly label to ${repo}#${issueNumber}`);
            }

            if (newValue === "Done" || newValue === "Backlog") {
              if (hasLabel) {
                await github.rest.issues.removeLabel({
                  owner, repo,
                  issue_number: issueNumber,
                  name: "shelly"
                });
                console.log(`Removed shelly label from ${repo}#${issueNumber}`);
              }
            }
