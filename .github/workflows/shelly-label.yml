name: "Kanban to Shelly Label Sync"

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  sync-labels:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const query = `query {
              user(login: "scarolan") {
                projectV2(number: 3) {
                  items(first: 50) {
                    nodes {
                      fieldValueByName(name: "Pipeline") {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                        }
                      }
                      content {
                        ... on Issue {
                          number
                          state
                          repository { name owner { login } }
                          labels(first: 10) { nodes { name } }
                        }
                      }
                    }
                  }
                }
              }
            }`;

            const result = await github.graphql(query);
            const items = result.user.projectV2.items.nodes;

            for (const item of items) {
              const pipeline = item.fieldValueByName?.name;
              const issue = item.content;
              if (!issue || !issue.number) continue;
              if (issue.state !== "OPEN") continue;

              const owner = issue.repository.owner.login;
              const repo = issue.repository.name;
              const hasLabel = issue.labels.nodes.some(l => l.name === "shelly");

              if (pipeline === "Ready for Shelly" && !hasLabel) {
                await github.rest.issues.addLabels({
                  owner, repo,
                  issue_number: issue.number,
                  labels: ["shelly"]
                });
                console.log("Labeled " + repo + "#" + issue.number);
              }

              if ((pipeline === "Backlog" || pipeline === "Done") && hasLabel) {
                try {
                  await github.rest.issues.removeLabel({
                    owner, repo,
                    issue_number: issue.number,
                    name: "shelly"
                  });
                  console.log("Unlabeled " + repo + "#" + issue.number);
                } catch(e) {}
              }
            }
